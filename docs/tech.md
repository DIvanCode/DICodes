# Техническая реализация

## Архитектура

<img src="architecture.png" width="800px">

## Компоненты

1. [Web User Interface (wui)](components/wui.md)
2. [Duel Management System (dms)](components/dms.md)
3. [Task Management System (fms)](components/tms.md)
4. [Exec Management System (ems)](components/ems.md)
5. [File Management System (fms)](components/fms.md)

## Third-party компоненты

1. [Nginx](https://nginx.org)
2. [PostgreSQL](https://www.postgresql.org)
3. [Kafka](https://kafka.apache.org)

## Процессы

### Тестирование решения задачи

- `wui` имеет web-socket соединение с `dms` через nginx и отправляет сообщение с запросом на тестирование решения задачи (1), а далее ожидает сообщения с изменением статуса тестирования в web-socket соединение
- `dms` делает http запрос в `tms` на тестирование решения задачи (2) и при успешном ответе (3) далее ожидает сообщения с изменением статуса тестирования в `kafka` из топика `testing`
- `tms` делает http запрос в `ems` на запуск команд тестирования решения задачи (4) и при успешном ответе (5) далее ожидает сообщения с результатами выполнения команд в `kafka` из топика `execution`
- `ems` при запуске команд отправляет сообщение о начале выполнения команд в `kafka` в топик `execution` (6)
- `tms` при получении сообщения о начале выполнения команд (7) отправляет сообщение о начале тестирования в `kafka` в топик `testing` (8)
- `dms` при получении сообщения о начале тестирования (9) отправляет сообщение о начале тестирования в web-socket соединение с `wui` (10)
- `ems` при выполнении каждой команды (11) отправляет событие о выполнении команды в `kafka` в топик `execution` (12)
- `tms` при получении сообщения о выполнении команды (13) отправляет сообщение об изменении статуса тестирования в `kafka` в топик `testing` (15), если нужно оповестить `dms` об этом (14)
- `dms` при получении сообщения об изменении статуса тестирования отправляет сообщение об изменении статуса тестирования в web-socket соединение с `wui` (16)
- `tms` после получения каждого сообщения о выполнении команд (13) определяет вердикт тестирования (18), если его можно определить (19), и отправляет его в `kafka` в топик `testing` (20)
- `ems` при окончании выполнения команд отправляет сообщение о завершении выполнения команд в `kafka` в топик `execution` (23)
- `tms` при получении сообщения об окончании выполнения команд (24) определяет вердикт тестирования (25), если он не был определен ранее (26), и отправляет его в `kafka` в топик `testing` (27)
- `dms` при получении сообщения с вердиктом (21, 28) тестирования отправляет его в web-socket соединение с `wui` (22, 29)

```mermaid
sequenceDiagram
    participant wui
    participant dms
    participant kafka [testing]
    participant tms
    participant kafka [execution]
    participant ems

    wui->>dms: (1) Протестировать решение задачи

    dms->>tms: (2) Протестировать решение задачи
    tms-->>dms: (3) Ок

    tms->>ems: (4) Запустить команды тестирования
    ems-->>tms: (5) Ок

    ems->>kafka [execution]: (6) Выполнение началось
    kafka [execution]-->>tms: (7) Выполнение началось

    tms->>kafka [testing]: (8) Тестирование началось
    kafka [testing]-->>dms: (9) Тестирование началось
    dms-->>wui: (10) Тестирование началось

    loop Выполнение команд тестирования задачи
        ems->>ems: (11) Выполнение одной команды
        ems->>kafka [execution]: (12) Одна команда выполнена
        kafka [execution]-->>tms: (13) Одна команда выполнена

        opt (14) Нужно оповестить dms об изменении статуса тестирования
        tms->>kafka [testing]: (15) Изменение статуса тестирования
        kafka [testing]-->>dms: (16) Изменение статуса тестирования
        dms-->>wui: (17) Изменение статуса тестирования
        end

        tms->>tms: (18) Определение вердикта, если он возможно

        opt (19) Определен вердикт тестирования
        tms->>kafka [testing]: (20) Вердикт тестирования
        kafka [testing]-->>dms: (21) Вердикт тестирования
        dms-->>wui: (22) Вердикт тестирования
        end
    end

    ems->>kafka [execution]: (23) Выполнение окончено
    kafka [execution]-->>tms: (24) Выполнение окончено

    tms->>tms: (25) Определение вердикта

    opt (26) Если вердикт не был определён ранее
    tms->>kafka [testing]: (27) Вердикт тестирования
    kafka [testing]-->>dms: (28) Вердикт тестирования
    dms-->>wui: (29) Вердикт тестирования
    end
```

### Выполнить код на входных данных

- `wui` имеет web-socket соединение с `dms` через nginx и отправляет сообщение с запросом на тестирование решения задачи (1), а далее ожидает сообщения с изменением статуса тестирования в web-socket соединение
- `dms` отправляет http запрос в `ems` на запуск команд выполнения кода (2) и при успешном ответе (3) далее ожидает сообщения с результатами выполнения команд в `kafka` из топика `execution`
- `ems` при запуске команд отправляет сообщение о начале выполнения команд в `kafka` в топик `execution` (4)
- `dms` при получении сообщения о начале выполнения команд (5) отправляет сообщение о начале тестирования в web-socket соединение с `wui` (6)
- `ems` при выполнении каждой команды (7) отправляет событие о выполнении команды в `kafka` в топик `execution` (8)
- `dms` при получении сообщения о выполнении команды (9) отправляет сообщение об изменении статуса выполнения кода в web-socket соединение с `wui` (10)
- `ems` при окончании выполнения команд отправляет сообщение о завершении выполнения команд в `kafka` в топик `execution` (11)
- `dms` при получении сообщения об окончании выполнения команд (12) отправляет в web-socket соединение с `wui` сообщение об окончании выполнения кода (13)

```mermaid
sequenceDiagram
    participant wui
    participant dms
    participant kafka [execution]
    participant ems

    wui->>dms: (1) Выполнить код на входных данных

    dms->>ems: (2) Запустить список команд выполнения кода
    ems-->>dms: (3) Ок

    ems->>kafka [execution]: (4) Выполнение началось
    kafka [execution]-->>dms: (5) Выполнение началось
    dms-->>wui: (6) Выполнение началось

    loop Выполнение команд
        ems->>ems: (7) Выполнение одной команды
        ems->>kafka [execution]: (8) Одна команда выполнена
        kafka [execution]-->>dms: (9) Одна команда выполнена
        dms-->>wui: (10) Изменение статуса выполнения кода
    end

    ems->>kafka [execution]: (11) Выполнение окончено
    kafka [execution]-->>dms: (12) Выполнение окончено
    dms-->>wui: (13) Выполнение окончено
```
